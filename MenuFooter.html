<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-M-8">
  <title>Builder Menu & Footer</title>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      background: #f6f8fa;
      margin: 0;
      padding: 0;
      min-width: 740px;
    }
    .tabs { display: flex; border-bottom: 2px solid #e0e0e0; background: #fff; }
    .tab { flex: 1; text-align: center; padding: 16px; cursor: pointer; font-weight: 500; border: none; background: none; outline: none; transition: background 0.2s; }
    .tab.active { border-bottom: 3px solid #073763; color: #073763; background: #f1f3f6; }
    .builder-container { display: flex; gap: 24px; padding: 24px; min-height: 480px; }
    .left-panel { flex: 1.1; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; padding: 20px; display: flex; flex-direction: column; min-width: 260px; max-width: 340px; height: 530px; overflow: hidden; }
    .right-panel { flex: 2; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; padding: 20px; display: flex; flex-direction: column; min-width: 360px; height: 530px; overflow: auto; }
    .search { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .search input { flex: 1; padding: 8px 10px; border-radius: 6px; border: 1px solid #e0e0e0; font-size: 14px; background: #f7f7fa; }
    .level-filter { margin-bottom: 8px; display: flex; gap: 12px; font-size: 13px; }
    .level-filter label { cursor: pointer; }
    .pages-list { flex: 1; overflow-y: auto; margin-bottom: 8px; border: 1px solid #f0f0f0; border-radius: 6px; background: #f9f9fb; padding: 5px 0; }
    .page-item { display: flex; align-items: center; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; cursor: pointer; background: #fff; transition: background 0.15s; }
    .page-item:last-child { border-bottom: none; }
    .page-item:hover { background: #eaf4fa; }
    .add-btn { background: #073763; color: #fff; border: none; border-radius: 6px; padding: 4px 12px; font-size: 13px; font-weight: 500; cursor: pointer; margin-left: 8px; }
    .menu-builder-list { flex: 1; overflow-y: auto; border: 1px solid #f0f0f0; border-radius: 6px; background: #fcfcfd; margin-bottom: 8px; padding: 7px 0; }
    .builder-item { display: flex; align-items: center; gap: 10px; padding: 7px 12px; border-bottom: 1px solid #f1f1f1; }
    .builder-item:last-child { border-bottom: none; }
    .order-btn, .remove-btn, .add-submenu-btn {
      background: none; border: none; cursor: pointer; color: #888; font-size: 17px; padding: 3px; margin-right: 2px;
    }
    .order-btn:hover, .remove-btn:hover, .add-submenu-btn:hover { color: #073763; }
    .rename-input { border: none; background: #f4f6f8; border-radius: 4px; padding: 3px 7px; font-size: 14px; width: 130px; margin-right: 7px; }
    .url-span { color: #7b7b7b; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; display: inline-block; margin-left: 10px; }
    .actions-bar { text-align: right; margin-top: 14px; }
    .save-btn { background: #073763; color: #fff; border: none; padding: 10px 24px; font-size: 15px; border-radius: 8px; font-weight: 500; cursor: pointer; box-shadow: 0 1px 6px #0002; margin-right: 12px; }
    .save-btn:active { background: #0b4a8a; }
    .info-bar { font-size: 13px; color: #4a5a6a; margin-top: 10px; }
    .submenu-list { margin-left: 38px; background: #f7f8fc; border-radius: 5px; padding: 2px 5px; }
    .submenu-label { font-size: 13px; color: #235; font-weight: 500; margin-right: 10px; }
    @media (max-width: 1000px) {
      .builder-container { flex-direction: column; gap: 14px; }
      .left-panel, .right-panel { max-width: none; min-width: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="tabs">
    <button class="tab active" id="tab-menu" onclick="switchTab('menu')">Menu principal</button>
    <button class="tab" id="tab-footer" onclick="switchTab('footer')">Footer</button>
  </div>
  <div class="builder-container">
    <div class="left-panel">
      <div class="level-filter">
        <label><input type="radio" name="level" value="1" checked onchange="renderArboList()">Niveau 1</label>
        <label><input type="radio" name="level" value="2" onchange="renderArboList()">Niveau 2</label>
        <label><input type="radio" name="level" value="3" onchange="renderArboList()">Niveau 3</label>
        <label><input type="radio" name="level" value="all" onchange="renderArboList()">Tous</label>
      </div>
      <div class="search">
        <input type="text" id="searchInput" placeholder="Filtrer les pages..." oninput="renderArboList()">
      </div>
      <div class="pages-list" id="arboList"></div>
      <div class="info-bar">Clique sur <b>+</b> pour ajouter une page.<br>
        (Filtrer par nom, URL, fil d'Ariane ou niveau)</div>
    </div>
    <div class="right-panel">
      <h3 id="builderTitle">Menu principal</h3>
      <div class="menu-builder-list" id="builderList"></div>
      <div class="actions-bar">
        <button class="save-btn" onclick="saveMenuFooter()">💾 Enregistrer</button>
      </div>
      <div class="info-bar" id="saveStatus"></div>
    </div>
  </div>
  <script>
    // === Variables globales ===
    let arboPages = [];
    let builderMenu = [];
    let builderFooter = [];
    let currentTab = 'menu';

    // ============ INIT ==============
    window.onload = function () {
      /*
       * Au chargement, on récupère à la fois la liste des pages de l'arborescence
       * et la dernière structure de menu/footer sauvegardée.
       */
      google.script.run.withSuccessHandler(function (initialData) {
        arboPages = Array.isArray(initialData.arboPages) ? initialData.arboPages : [];
        const pageMap = new Map(arboPages.map(p => [p.URL, p]));

        // Fonction pour "réhydrater" les données sauvegardées avec les données complètes de l'arborescence
        function hydrateState(items) {
          if (!items || items.length === 0) return [];
          return items.map(item => {
            const originalPage = pageMap.get(item.url);
            // On fusionne l'objet d'origine et l'objet sauvegardé.
            // Les propriétés sauvegardées (label, nonClickable) écrasent celles d'origine.
            const hydratedItem = { ...originalPage, ...item };
            
            if (item.children && item.children.length > 0) {
              hydratedItem.children = hydrateState(item.children);
            }
            return hydratedItem;
          }).filter(Boolean); // On retire les items qui n'existeraient plus dans l'arborescence
        }
        
        if (initialData.savedState) {
            builderMenu = hydrateState(initialData.savedState.menu || []);
            builderFooter = hydrateState(initialData.savedState.footer || []);
        }
        
        renderArboList();
        renderBuilder();
      }).getInitialMenuFooterData();
    };

    // ========== TABS ===========
    function switchTab(tab) {
      currentTab = tab;
      document.getElementById('tab-menu').classList.toggle('active', tab === 'menu');
      document.getElementById('tab-footer').classList.toggle('active', tab === 'footer');
      document.getElementById('builderTitle').textContent = (tab === 'menu') ? 'Menu principal' : 'Footer';
      renderArboList();
      renderBuilder();
      document.getElementById('saveStatus').textContent = '';
    }

    // ========== LISTE ARBO (filtrable par niveau) ================
      function renderArboList() {
        const filter = document.getElementById('searchInput').value.trim().toLowerCase();
        const levelFilter = document.querySelector('input[name="level"]:checked').value;
        const listDiv = document.getElementById('arboList');
        if (!arboPages.length) {
          listDiv.innerHTML = '<i>Aucune page dans l’arborescence</i>';
          return;
        }
        let filtered = arboPages.filter(p => String(p.Niveau) !== "0" && p.Niveau !== 0);
        if (levelFilter !== 'all') filtered = filtered.filter(p => String(p.Niveau) === levelFilter);
        if (filter) {
          filtered = filtered.filter(p =>
            (p.Nom || '').toLowerCase().includes(filter) ||
            (p.URL || '').toLowerCase().includes(filter) ||
            (p['Fil d\'Ariane'] || '').toLowerCase().includes(filter) ||
            (String(p.Niveau || '')).includes(filter)
          );
        }
        if (!filtered.length) {
          listDiv.innerHTML = '<i>Aucune page trouvée pour ce filtre</i>';
          return;
        }
        listDiv.innerHTML = '';
        filtered.forEach((page, idx) => {
          const btn = document.createElement('button');
          btn.className = 'add-btn';
          btn.textContent = '+';
          btn.title = "Ajouter à la racine";
          btn.onclick = function () { addPageToBuilder(page); };
          const item = document.createElement('div');
          item.className = 'page-item';
          item.innerHTML = `<span>${page.Nom || '[Sans nom]'}</span>
            <span class="url-span" title="${page.URL || ''}">${page.urlRelative || ''}</span>`;
          item.appendChild(btn);
          listDiv.appendChild(item);
        });
      }

    // ========== BUILDER ================
    function renderBuilder() {
      const builderDiv = document.getElementById('builderList');
      const builder = (currentTab === 'menu') ? builderMenu : builderFooter;
      if (!builder.length) {
        builderDiv.innerHTML = '<i>Ajoute des pages à ton ' + ((currentTab === 'menu') ? 'menu' : 'footer') + '.</i>';
        return;
      }
      builderDiv.innerHTML = '';
      
      builder.forEach((item, i) => {
        const line = document.createElement('div');
        line.className = 'builder-item';
        const up = document.createElement('button');
        up.className = 'order-btn';
        up.innerHTML = '⬆️';
        up.title = 'Monter';
        up.onclick = () => moveItem(i, -1);
        up.disabled = (i === 0);
        const down = document.createElement('button');
        down.className = 'order-btn';
        down.innerHTML = '⬇️';
        down.title = 'Descendre';
        down.onclick = () => moveItem(i, 1);
        down.disabled = (i === builder.length - 1);
        const input = document.createElement('input');
        input.type = 'text';
        input.value = item.label || item.Nom || '';
        input.className = 'rename-input';
        input.title = 'Libellé affiché';
        input.onchange = e => { item.label = e.target.value; };
        
        const url = document.createElement('span');
        url.className = 'url-span';
        url.textContent = item.urlRelative || '';
        url.title = item.URL || '';
        
        const subBtn = document.createElement('button');
        subBtn.className = 'add-submenu-btn';
        subBtn.innerHTML = '➕ Sous-menu';
        subBtn.title = 'Ajouter un sous-menu';
        if (String(item.Niveau) === '1') {
            subBtn.onclick = () => showSubmenuSelector(i);
        } else if (String(item.Niveau) === '2') {
            subBtn.onclick = () => showSubsubmenuSelector(i, -1);
        } else {
            subBtn.style.display = 'none';
        }
        const rm = document.createElement('button');
        rm.className = 'remove-btn';
        rm.innerHTML = '🗑️';
        rm.title = 'Supprimer';
        rm.onclick = () => removeItem(i);
        const nonClickableLabel = document.createElement('label');
        nonClickableLabel.style.cssText = 'margin-left:auto; font-size:13px; color:#555; cursor:pointer; display:flex; align-items:center;';
        const nonClickableCheckbox = document.createElement('input');
        nonClickableCheckbox.type = 'checkbox';
        nonClickableCheckbox.checked = !!item.nonClickable;
        nonClickableCheckbox.onchange = () => { item.nonClickable = nonClickableCheckbox.checked; };
        nonClickableLabel.appendChild(nonClickableCheckbox);
        nonClickableLabel.appendChild(document.createTextNode(' Non cliquable'));
        line.appendChild(up);
        line.appendChild(down);
        line.appendChild(input);
        line.appendChild(url);
        line.appendChild(subBtn);
        line.appendChild(rm);
        line.appendChild(nonClickableLabel);
        builderDiv.appendChild(line);

        if (item.children && item.children.length) {
          const subDiv = document.createElement('div');
          subDiv.className = 'submenu-list';
          item.children.forEach((subitem, j) => {
            const subline = document.createElement('div');
            subline.className = 'builder-item';
            subline.style.background = '#f3f5fa';
            const subinput = document.createElement('input');
            subinput.type = 'text';
            subinput.value = subitem.label || subitem.Nom || '';
            subinput.className = 'rename-input';
            subinput.title = 'Libellé sous-menu';
            subinput.onchange = e => { subitem.label = e.target.value; };
            
            const suburl = document.createElement('span');
            suburl.className = 'url-span';
            suburl.textContent = subitem.urlRelative || '';
            suburl.title = subitem.URL || '';
            
            const subSubBtn = document.createElement('button');
            subSubBtn.className = 'add-submenu-btn';
            subSubBtn.innerHTML = '➕ Sous-menu';
            subSubBtn.title = 'Ajouter un sous-menu de niveau 3';
            subSubBtn.onclick = () => showSubsubmenuSelector(i, j);
            const subrm = document.createElement('button');
            subrm.className = 'remove-btn';
            subrm.innerHTML = '🗑️';
            subrm.title = 'Supprimer';
            subrm.onclick = () => removeSubmenu(i, j);
            const subNonClickableLabel = document.createElement('label');
            subNonClickableLabel.style.cssText = 'margin-left:auto; font-size:13px; color:#555; cursor:pointer; display:flex; align-items:center;';
            const subNonClickableCheckbox = document.createElement('input');
            subNonClickableCheckbox.type = 'checkbox';
            subNonClickableCheckbox.checked = !!subitem.nonClickable;
            subNonClickableCheckbox.onchange = () => { subitem.nonClickable = subNonClickableCheckbox.checked; };
            subNonClickableLabel.appendChild(subNonClickableCheckbox);
            subNonClickableLabel.appendChild(document.createTextNode(' Non cliquable'));
            subline.appendChild(document.createElement('span')).textContent = '↳';
            subline.appendChild(subinput);
            subline.appendChild(suburl);
            subline.appendChild(subSubBtn);
            subline.appendChild(subrm);
            subline.appendChild(subNonClickableLabel);
            subDiv.appendChild(subline);

            if (subitem.children && subitem.children.length) {
              const subSubDiv = document.createElement('div');
              subSubDiv.className = 'submenu-list';
              subitem.children.forEach((subsubitem, k) => {
                const subsubline = document.createElement('div');
                subsubline.className = 'builder-item';
                subsubline.style.background = '#f8fafb';
                const subsubinput = document.createElement('input');
                subsubinput.type = 'text';
                subsubinput.value = subsubitem.label || subsubitem.Nom || '';
                subsubinput.className = 'rename-input';
                subsubinput.title = 'Libellé sous-menu';
                subsubinput.onchange = e => { subsubitem.label = e.target.value; };

                const subsuburl = document.createElement('span');
                subsuburl.className = 'url-span';
                subsuburl.textContent = subsubitem.urlRelative || '';
                subsuburl.title = subsubitem.URL || '';
                
                const subsubrm = document.createElement('button');
                subsubrm.className = 'remove-btn';
                subsubrm.innerHTML = '🗑️';
                subsubrm.title = 'Supprimer';
                subsubrm.onclick = () => removeSubsubmenu(i, j, k);
                const subSubNonClickableLabel = document.createElement('label');
                subSubNonClickableLabel.style.cssText = 'margin-left:auto; font-size:13px; color:#555; cursor:pointer; display:flex; align-items:center;';
                const subSubNonClickableCheckbox = document.createElement('input');
                subSubNonClickableCheckbox.type = 'checkbox';
                subSubNonClickableCheckbox.checked = !!subsubitem.nonClickable;
                subSubNonClickableCheckbox.onchange = () => { subsubitem.nonClickable = subSubNonClickableCheckbox.checked; };
                subSubNonClickableLabel.appendChild(subSubNonClickableCheckbox);
                subSubNonClickableLabel.appendChild(document.createTextNode(' Non cliquable'));
                subsubline.appendChild(document.createElement('span')).textContent = '↳';
                subsubline.appendChild(subsubinput);
                subsubline.appendChild(subsuburl);
                subsubline.appendChild(subsubrm);
                subsubline.appendChild(subSubNonClickableLabel);
                subSubDiv.appendChild(subsubline);
              });
              subDiv.appendChild(subSubDiv);
            }
          });
          builderDiv.appendChild(subDiv);
        }
      });
    }

    // ===== Ajout de page =====
    function addPageToBuilder(page) {
        const builder = (currentTab === 'menu') ? builderMenu : builderFooter;
        const builderName = (currentTab === 'menu') ? 'menu' : 'footer';
        
        // Vérifie si la page est déjà présente dans toute la structure (y compris les enfants)
        function isPageInBuilder(items, url) {
            for (const item of items) {
                if ((item.URL || item.url) === url) return true;
                if (item.children && isPageInBuilder(item.children, url)) return true;
            }
            return false;
        }

        if (isPageInBuilder(builder, page.URL)) {
            document.getElementById('saveStatus').textContent = '⚠️ Déjà présent dans le ' + builderName;
            return;
        }
        
        // Ajoute la page à la racine. La logique d'affichage gère le reste.
        builder.push({ ...page, label: page.Nom, children: [] });
        renderBuilder();
    }

    // ========== SOUS-MENUS (inchangé) =============
    function showSubmenuSelector(parentIdx, pageToAdd) {
      const builder = (currentTab === 'menu') ? builderMenu : builderFooter;
      let oldPopin = document.getElementById("sf-poppin");
      if (oldPopin) oldPopin.remove();
      if (pageToAdd) {
        const parents = builder.filter(p => String(p.Niveau) === '1').map((itm, idx) => `<option value="${idx}">${itm.label || itm.Nom}</option>`).join('');
        if (!parents) {
            alert("Aucun item de niveau 1 n'existe pour y rattacher cette page.");
            return;
        }
        const html = `
          <div style="padding:18px 18px 8px 18px;font-family:Arial">
            <b>Ajouter "<span style='color:#073763'>${pageToAdd.Nom}</span>" à quel item principal ?</b><br><br>
            <select id="sf-selParent">${parents}</select>
            <button id="sf-okBtn" style="margin-left:10px;background:#073763;color:#fff;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;">Ajouter</button>
            <button id="sf-cancelBtn" style="margin-left:10px;background:#ddd;color:#333;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;">Annuler</button>
          </div>`;
        const dlg = document.createElement('div');
        dlg.id = "sf-poppin";
        dlg.innerHTML = html;
        dlg.style.position = "fixed";
        dlg.style.top = "30%";
        dlg.style.left = "38%";
        dlg.style.zIndex = 9999;
        dlg.style.background = "#fff";
        dlg.style.borderRadius = "12px";
        dlg.style.boxShadow = "0 4px 16px #0002";
        dlg.style.padding = "0";
        document.body.appendChild(dlg);
        dlg.onclick = (e) => e.stopPropagation();
        document.getElementById("sf-okBtn").onclick = function() {
          const pidx = parseInt(document.getElementById("sf-selParent").value, 10);
          if (!builder[pidx].children) builder[pidx].children = [];
          if (builder[pidx].children.some(child => child.URL === pageToAdd.URL)) {
            alert("Déjà présent dans ce sous-menu.");
            dlg.remove(); return;
          }
          builder[pidx].children.push({ ...pageToAdd, label: pageToAdd.Nom });
          renderBuilder();
          dlg.remove();
        };
        document.getElementById("sf-cancelBtn").onclick = () => dlg.remove();
        setTimeout(() => document.body.addEventListener('click', () => dlg.remove(), { once: true }), 30);
        return;
      }
      let parentName = builder[parentIdx].Nom || builder[parentIdx].label;
      let options = arboPages.filter(p => String(p.Niveau) === "2" && (p['Niveau parent'] === parentName) && !builder[parentIdx].children?.some(child => child.URL === p.URL));
      if (!options.length) {
        alert("Aucune page niveau 2 disponible ou tout a déjà été ajouté comme sous-menu.");
        return;
      }
      const optionsHtml = options.map(p => `<option value="${p.URL}">${p.Nom} (${p.urlRelative || p.URL})</option>`).join('');
      const html = `
        <div style="padding:18px 18px 8px 18px;font-family:Arial">
          <b>Choisir la page à ajouter en sous-menu :</b><br><br>
          <select id="sf-selSubmenu">${optionsHtml}</select>
          <button id="sf-okBtn2" style="margin-left:10px;background:#073763;color:#fff;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;">Ajouter</button>
          <button id="sf-cancelBtn2" style="margin-left:10px;background:#ddd;color:#333;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;">Annuler</button>
        </div>`;
      const dlg = document.createElement('div');
      dlg.id = "sf-poppin";
      dlg.innerHTML = html;
      dlg.style.position = "fixed";
      dlg.style.top = "30%";
      dlg.style.left = "38%";
      dlg.style.zIndex = 9999;
      dlg.style.background = "#fff";
      dlg.style.borderRadius = "12px";
      dlg.style.boxShadow = "0 4px 16px #0002";
      dlg.style.padding = "0";
      document.body.appendChild(dlg);
      dlg.onclick = (e) => e.stopPropagation();
      document.getElementById("sf-okBtn2").onclick = function() {
        const url = document.getElementById("sf-selSubmenu").value;
        const page = arboPages.find(p => p.URL === url);
        if (!builder[parentIdx].children) builder[parentIdx].children = [];
        builder[parentIdx].children.push({ ...page, label: page.Nom });
        renderBuilder();
        dlg.remove();
      };
      document.getElementById("sf-cancelBtn2").onclick = () => dlg.remove();
      setTimeout(() => document.body.addEventListener('click', () => dlg.remove(), { once: true }), 30);
    }
    function removeSubmenu(parentIdx, subIdx) {
      const builder = (currentTab === 'menu') ? builderMenu : builderFooter;
      builder[parentIdx].children.splice(subIdx, 1);
      renderBuilder();
    }
    function showSubsubmenuSelector(parentIdx, subIdx) {
      const builder = (currentTab === 'menu') ? builderMenu : builderFooter;
      let subitem;
      if (subIdx === -1) {
          subitem = builder[parentIdx];
      } else {
          subitem = builder[parentIdx].children[subIdx];
      }
      let parentName = subitem.Nom || subitem.label;
      let options = arboPages.filter(p => String(p.Niveau) === "3" && (p['Niveau parent'] === parentName) && !(subitem.children || []).some(child => child.URL === p.URL));
      if (!options.length) {
        alert("Aucune page niveau 3 disponible ou tout a déjà été ajouté comme sous-menu.");
        return;
      }
      const optionsHtml = options.map(p => `<option value="${p.URL}">${p.Nom} (${p.urlRelative || p.URL})</option>`).join('');
      const html = `
        <div style="padding:18px 18px 8px 18px;font-family:Arial">
          <b>Choisir la page à ajouter en sous-menu de niveau 3 :</b><br><br>
          <select id="sf-selSubsubmenu">${optionsHtml}</select>
          <button id="sf-okBtn3" style="margin-left:10px;background:#073763;color:#fff;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;">Ajouter</button>
          <button id="sf-cancelBtn3" style="margin-left:10px;background:#ddd;color:#333;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;">Annuler</button>
        </div>`;
      let oldPopin = document.getElementById("sf-poppin");
      if (oldPopin) oldPopin.remove();
      const dlg = document.createElement('div');
      dlg.id = "sf-poppin";
      dlg.innerHTML = html;
      dlg.style.position = "fixed";
      dlg.style.top = "34%";
      dlg.style.left = "40%";
      dlg.style.zIndex = 9999;
      dlg.style.background = "#fff";
      dlg.style.borderRadius = "12px";
      dlg.style.boxShadow = "0 4px 16px #0002";
      dlg.style.padding = "0";
      document.body.appendChild(dlg);
      dlg.onclick = (e) => e.stopPropagation();
      document.getElementById("sf-okBtn3").onclick = function() {
        const url = document.getElementById("sf-selSubsubmenu").value;
        const page = arboPages.find(p => p.URL === url);
        if (!subitem.children) subitem.children = [];
        subitem.children.push({ ...page, label: page.Nom });
        renderBuilder();
        dlg.remove();
      };
      document.getElementById("sf-cancelBtn3").onclick = () => dlg.remove();
      setTimeout(() => document.body.addEventListener('click', () => dlg.remove(), { once: true }), 30);
    }
    function removeSubsubmenu(parentIdx, subIdx, subsubIdx) {
      const builder = (currentTab === 'menu') ? builderMenu : builderFooter;
      builder[parentIdx].children[subIdx].children.splice(subsubIdx, 1);
      renderBuilder();
    }
    function removeItem(idx) {
      const builder = (currentTab === 'menu') ? builderMenu : builderFooter;
      builder.splice(idx, 1);
      renderBuilder();
    }
    function moveItem(idx, direction) {
      const builder = (currentTab === 'menu') ? builderMenu : builderFooter;
      const swap = idx + direction;
      if (swap < 0 || swap >= builder.length) return;
      [builder[idx], builder[swap]] = [builder[swap], builder[idx]];
      renderBuilder();
    }

    // ========== ENREGISTREMENT ============
    function saveMenuFooter() {
      const createExportArray = (builder) => {
          return builder.map(item => ({
              label: item.label || item.Nom,
              url: item.URL || item.url, 
              Niveau: item.Niveau,
              nonClickable: item.nonClickable || false,
              children: (item.children && item.children.length > 0) ? createExportArray(item.children) : []
          }));
      };

      const menuData = createExportArray(builderMenu);
      const footerData = createExportArray(builderFooter);

      document.getElementById('saveStatus').textContent = 'Enregistrement...';
      google.script.run
        .withSuccessHandler(() => {
          document.getElementById('saveStatus').textContent = '✅ Structure enregistrée avec succès !';
        })
        .withFailureHandler(err => {
          document.getElementById('saveStatus').textContent = '❌ Erreur : ' + err.message;
        })
        .createMenuFooter({ menu: menuData, footer: footerData });
    }
  </script>
</body>
</html>